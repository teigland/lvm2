#
# Copyright (C) 2001-2004 Sistina Software, Inc. All rights reserved.
# Copyright (C) 2004-2010 Red Hat, Inc. All rights reserved.
#
# This file is part of the device-mapper userspace tools.
#
# This copyrighted material is made available to anyone wishing to use,
# modify, copy, or redistribute it subject to the terms and conditions
# of the GNU Lesser General Public License v.2.1.
#
# You should have received a copy of the GNU Lesser General Public License
# along with this program; if not, write to the Free Software Foundation,
# Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA

DM_SOURCES =\
	libdm/datastruct/bitset.c \
	libdm/datastruct/hash.c \
	libdm/datastruct/list.c \
	libdm/libdm-common.c \
	libdm/libdm-config.c \
	libdm/libdm-deptree.c \
	libdm/libdm-file.c \
	libdm/libdm-report.c \
	libdm/libdm-stats.c \
	libdm/libdm-string.c \
	libdm/libdm-targets.c \
	libdm/libdm-timestamp.c \
	libdm/mm/dbg_malloc.c \
	libdm/mm/pool.c \
	libdm/regex/matcher.c \
	libdm/regex/parse_rx.c \
	libdm/regex/ttree.c \
	libdm/ioctl/libdm-iface.c
LIBDM_DEPENDS=$(subst .c,.d,$(LIBDM_SOURCE))
LIBDM_OBJECTS=$(subst .c,.o,$(LIBDM_SOURCE))
CLEAN_TARGETS+=$(LIBDM_DEPENDS) $(LIBDM_OBJECTS)

$(DM_OBJECTS): INCLUDES += -Ilibdm/ioctl

libdm/ioctl/libdevmapper.a: $(LIBDM_OBJECTS)
	@echo "    [AR] $@"
	$(Q) $(RM) $@
	$(Q) $(AR) rsv $@ $(OBJECTS) > /dev/null

libdm/ioctl/libdevmapper.so.$(LIB_VERSION_DM): $(LIBDM_OBJECTS)
	@echo "    [CC] $@"
	$(Q) $(CC) -shared -Wl,-soname,$(notdir $@) \
		$(CFLAGS) $(CLDFLAGS) $(LIBDM_OBJECTS) $(LIBS) -o $@

TARGETS += libdm/ioctl/libdevmapper.so libdm/ioctl/libdevmapper.so.$(LIB_VERSION)
CLEAN_TARGETS += libdm/ioctl/libdevmapper.a libdm/ioctl/libdevmapper.so.$(LIB_VERSION)
DISTCLEAN_TARGETS += libdevmapper.pc

#CFLOW_LIST = $(SOURCES)
#CFLOW_LIST_TARGET = libdevmapper.cflow

EXPORTED_HEADER = libdm/libdevmapper.h
EXPORTED_FN_PREFIX = dm

PROGS_CFLAGS = $(UDEV_CFLAGS)

LIBS += $(RT_LIBS) $(SELINUX_LIBS) $(UDEV_LIBS) $(PTHREAD_LIBS) $(M_LIBS)

libdm/libdevmapper.$(LIB_SUFFIX) libdm/libdevmapper.$(LIB_SUFFIX).$(LIB_VERSION): libdm/ioctl/libdevmapper.so.$(LIB_VERSION_DM)
	$(LN_S) -f $< $@

.PHONY: install_dynamic install_static install_include \
	install_ioctl install_ioctl_static \
	install_pkgconfig

INSTALL_TYPE = install_dynamic

ifeq ("@STATIC_LINK@", "yes")
  INSTALL_TYPE += install_static
endif

ifeq ("@PKGCONFIG@", "yes")
  INSTALL_TYPE += install_pkgconfig
endif

install: $(INSTALL_TYPE) install_include

install_device-mapper: install

install_include: $(srcdir)/libdevmapper.h
	$(INSTALL_DATA) -D $< $(includedir)/$(<F)

install_dynamic: install_ioctl

install_static: install_ioctl_static

install_ioctl: install_lib_shared

install_pkgconfig: libdevmapper.pc
	$(INSTALL_DATA) -D $< $(pkgconfigdir)/devmapper.pc

install_ioctl_static: $(LIB_STATIC)
	$(INSTALL_DATA) -D $< $(usrlibdir)/$(<F)

