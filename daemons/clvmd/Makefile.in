#
# Copyright (C) 2004 Red Hat, Inc. All rights reserved.
#
# This file is part of LVM2.
#
# This copyrighted material is made available to anyone wishing to use,
# modify, copy, or redistribute it subject to the terms and conditions
# of the GNU General Public License v.2.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software Foundation,
# Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA

CMAN_LIBS = @CMAN_LIBS@
CMAN_CFLAGS = @CMAN_CFLAGS@
CMAP_LIBS = @CMAP_LIBS@
CMAP_CFLAGS = @CMAP_CFLAGS@
CONFDB_LIBS = @CONFDB_LIBS@
CONFDB_CFLAGS = @CONFDB_CFLAGS@
CPG_LIBS = @CPG_LIBS@
CPG_CFLAGS = @CPG_CFLAGS@
DLM_LIBS = @DLM_LIBS@
DLM_CFLAGS = @DLM_CFLAGS@
QUORUM_LIBS = @QUORUM_LIBS@
QUORUM_CFLAGS = @QUORUM_CFLAGS@
SALCK_LIBS = @SALCK_LIBS@
SALCK_CFLAGS = @SALCK_CFLAGS@

CLVMD_SOURCE=\
	daemons/clvmd/clvmd-command.c \
	daemons/clvmd/clvmd.c \
	daemons/clvmd/lvm-functions.c \
	daemons/clvmd/refresh_clvmd.c

ifneq (,$(findstring cman,, "@CLVMD@,"))
	CLVMD_SOURCE += daemons/clvmd/clvmd-cman.c
endif

ifneq (,$(findstring openais,, "@CLVMD@,"))
	CLVMD_SOURCE += daemons/clvmd/clvmd-openais.c
endif

ifneq (,$(findstring corosync,, "@CLVMD@,"))
	CLVMD_SOURCE += daemons/clvmd/clvmd-corosync.c
endif

ifneq (,$(findstring singlenode,, &quot;@CLVMD@,&quot;))
	CLVMD_SOURCE += daemons/clvmd/clvmd-singlenode.c
endif

CLVMD_DEPENDS=$(subst .c,.d,$(CLVMD_SOURCE))
CLVMD_OBJECTS=$(subst .c,.o,$(CLVMD_SOURCE))
CLEAN_TARGETS+=daemons/clvmd/*.d daemons/clvmd/*.o

ifneq (,$(findstring cman,, "@CLVMD@,"))
daemons/clvmd/clvmd: LIBS += $(CMAN_LIBS) $(CONFDB_LIBS) $(DLM_LIBS)
$(CLVMD_OBJECTS): CFLAGS += $(CMAN_CFLAGS) $(CONFDB_CFLAGS) $(DLM_CFLAGS) -DUSE_CMAN
endif

ifneq (,$(findstring openais,, "@CLVMD@,"))
daemons/clvmd/clvmd: LIBS += $(CONFDB_LIBS) $(CPG_LIBS) $(SALCK_LIBS)
$(CLVMD_OBJECTS): CFLAGS += $(CONFDB_CFLAGS) $(CPG_CFLAGS) $(SALCK_CFLAGS) -DUSE_OPENAIS
endif

ifneq (,$(findstring corosync,, "@CLVMD@,"))
daemons/clvmd/clvmd: LIBS += $(CMAP_LIBS) $(CONFDB_LIBS) $(CPG_LIBS) $(DLM_LIBS) $(QUORUM_LIBS)
$(CLVMD_OBJECTS): CFLAGS += $(CMAP_CFLAGS) $(CONFDB_CFLAGS) $(CPG_CFLAGS) $(DLM_CFLAGS) $(QUORUM_CFLAGS) -DUSE_COROSYNC
endif

ifneq (,$(findstring singlenode,, &quot;@CLVMD@,&quot;))
$(CLVMD_OBJECTS): CFLAGS += -DUSE_SINGLENODE
endif

daemons/clvmd/clvmd: LIBS += $(LVMINTERNAL_LIBS) -ldevmapper $(PTHREAD_LIBS) -laio
$(CLVMD_OBJECTS): CFLAGS += -fno-strict-aliasing $(EXTRA_EXEC_CFLAGS)

daemons/clvmd/clvmd: $(CLVMD_OBJECTS) lib/liblvm-internal.a libdaemon/client/libdaemonclient.a
	@echo [LD]  $@
	$(Q) $(CC) $(CFLAGS) $(INCLUDES) $(LDFLAGS) $(EXTRA_EXEC_LDFLAGS) $(ELDFLAGS) \
	      -o daemons/clvmd/clvmd $(CLVMD_OBJECTS) $(LIBS)

.PHONY: install_clvmd

INSTALL_TARGETS = \
	install_clvmd

install_clvmd: daemons/clvmd/clvmd
	$(INSTALL_PROGRAM) -D daemons/clvmd/clvmd $(usrsbindir)/clvmd

install: $(INSTALL_TARGETS)

install_cluster: $(INSTALL_TARGETS)
